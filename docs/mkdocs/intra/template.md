# 云模板

## 什么是云模板

云模板是CloudIaC中定义的一种可以部署的环境类型；

云模板由名称、描述、一组描述部署的有效配置文件以及一组变量组成；

通过云模板中的『部署新环境』可以立即开始创建新环境。

## 创建云模板

云模板需要关联到您的git仓库，该仓库包含您对资源的描述配置文件，以及在资源创建成功后需要部署的应用描述配置文件；

在创建云模板之前您需要添加VCS来源，在『组织设置』-『VCS』中，点击『添加VCS』来添加新的git仓库来源；

要创建新模板，请点击『组织设置』-『云模板』中的『新建云模板』来进行添加；

输入模板名称、描述、选择相应的VCS和代码仓库、分支/标签信息，您还可以指定部署时的工作目录，以及使用的 terraform 版本；

接下来您可以编辑云模板中的变量，编辑时您可以看到从组织中继承的变量，您可以对继承的变量进行重新赋值或创建新的变量；

您可以在变量配置中选择是否需要加载指定的 terraform 的 tfvars 文件；

如果您的资源描述配置文件包含对应用部署的配置，则您可以选择需要在部署中使用的playbook文件，这样在部署过程中terraform创建资源完成后会自动调用ansible playbook来进行应用的自动部署；

最后选择将云模板关联到哪些项目，关联的项目下就可以使用该云模板进行环境的部署了。

## 管理云模板

云模板在组织范围内添加、编辑或删除；

云模板由组织管理员创建、编辑和删除，普通用户只能基于已创建好的云模板进行部署或plan计划，但可以在发起部署操作时对变量进行修改；

在云模板创建后，您可以在编辑操作中修改云模板的配置，例如引用不同VCS仓库的代码仓库、分支或标签；

对云模板的修改只会影响基于该云模板的新部署，要将更新应用到活跃状态的环境，必须对该环境执行『重新部署』；

如果您需要删除云模板，在检查该云模板没有活跃状态的环境存在的前提下，可以删除该云模板。

## Terraform 版本选择
在创建云模板时可以选择需要使用的 terraform 版本，我们预置了主流的 terraform 版本供选择，或者让系统自动匹配。

选择自动匹配时，我们读取您模板代码库的 versions.tf 文件中的版本约束，若预置列表中有满足约束的版本则使用匹配的版本，若无则会在 terraform 的所有版本中选择最小满足版本约束的版本。

如果使用的非内置 terraform 版本，则会在执行部署时实时下载。runner 会对己下载的版本进行缓存，避免重复下载。
